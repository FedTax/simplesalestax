!function(c){var d=SST_Certificate_Table_Data,a=wp.template("sst-certificate-row"),n=wp.template("sst-certificate-row-blank"),s=Backbone.Model.extend({certificates:{},selected:""}),r=Backbone.View.extend({userId:0,addressFields:{},initialize:function(e){this.userId=e.user_id?+e.user_id:0,this.addressFields=e.address_fields||{},this.listenTo(this.model,"change:certificates",this.render),this.listenTo(this.model,"change:selected",this.fireChangeHook),c(document.body).on("click",".sst-certificate-add",{view:this},this.onAddCertificate)},render:function(){var e=_.indexBy(this.model.get("certificates"),"CertificateID"),t=this.model.get("selected"),i=this,s=1;this.$el.empty(),_.size(e)?(c.each(e,function(e,t){t.Index=s++,i.$el.append(a(t))}),i.$el.find(".sst-certificate-delete").on("click",{view:this},this.onDeleteRow),i.$el.find(".sst-certificate-view").on("click",{view:this},this.onViewCertificate),i.$el.find('input[name="certificate_id"]').on("change",this.updateSelected.bind(this)),t?c('input[name="certificate_id"][value="'+t+'"]').prop("checked",!0):(t=c('input[name="certificate_id"]').first())&&(t.prop("checked",!0),this.model.set("selected",t.val()))):i.$el.append(n)},fireChangeHook:function(){var e=this.model.get("selected");wp.hooks.doAction("sst_certificate_changed",e)},block:function(){c(this.el).block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(){c(this.el).unblock()},updateSelected:function(e){this.model.set("selected",c(e.target).val())},onDeleteRow:function(e){var t=e.data.view,i=t.model,s=(_.indexBy(i.get("certificates"),"CertificateID"),t.model.get("selected")),a=c(this).closest("tr").data("id");e.preventDefault(),confirm(d.strings.delete_certificate)&&(t.block(),e={nonce:d.delete_certificate_nonce,certificate_id:a},t.userId&&(e.user_id=t.userId),c.post(d.ajaxurl+"?action=sst_delete_certificate",e).done(function(e){if(!e.success)throw new Error(e.data);s==a&&t.model.set("selected",""),t.model.set("certificates",e.data.certificates),t.model.trigger("change:certificates")}).fail(function(){alert(d.strings.delete_failed)}).always(function(){t.unblock()}))},onViewCertificate:function(e){var t=e.data.view.model,t=_.indexBy(t.get("certificates"),"CertificateID")[c(this).closest("tr").data("id")];e.preventDefault(),t&&c(this).SSTBackboneModal({template:"sst-modal-view-certificate",variable:t})},onAddCertificate:function(e){e.preventDefault();e=e.data.view;SST_Add_Certificate_Modal.open({address:e.getBillingAddress(),onAddCertificate:e.addCertificateHandler.bind(e)})},getBillingAddress:function(){var e,t,i={first_name:"",last_name:"",address_1:"",address_2:"",city:"",state:"",postcode:""},s=this.addressFields;for(e in i)i.hasOwnProperty(e)&&e in s&&(t=s[e],i[e]=c('[name="'+t+'"]').val());return i},addCertificateHandler:function(e){var t=this;t.block();e={nonce:SST_Add_Certificate_Data.nonce,certificate:e,address:t.getBillingAddress()};t.userId&&(e.user_id=t.userId),c.post(d.ajaxurl+"?action=sst_add_certificate",e).done(function(e){if(!e.success)throw new Error(e.data);t.model.set("selected",e.data.certificate_id),t.model.set("certificates",e.data.certificates),t.model.trigger("change:certificates")}).fail(function(){alert(d.strings.add_failed)}).always(function(){t.unblock()})}});window.renderCertificateTable=function(e){e=e||{};var t,i={selector:"#sst-certificates",address_fields:{first_name:"billing_first_name",last_name:"billing_last_name",address_1:"billing_address_1",address_2:"billing_address_2",city:"billing_city",state:"billing_state",postcode:"billing_postcode"},certificates:{},selected:"",user_id:0};for(t in i)i.hasOwnProperty(t)&&!e.hasOwnProperty(t)&&(e[t]=i[t]);e.model=new s({certificates:e.certificates,selected:e.selected}),e.el=c(e.selector).find("tbody"),new r(e).render()}}(jQuery);